# Код-ревью проекта (RU)

Документ фиксирует результаты тщательного ревью кодовой базы: архитектура, качество, риски, наблюдаемость, тесты и рекомендации по улучшению. Оценки — по шкале 0–10.

## Краткое резюме

Проект — полноценный стек для мониторинга/аналитики/прогнозирования метрик:
- **Backend**: FastAPI + SQLAlchemy + PostgreSQL.
- **UI**: Streamlit с несколькими страницами и визуализациями (Plotly).
- **ML/Forecasting**: Prophet, логика обучения/подбора параметров, сохранение моделей.
- **Инфра**: docker-compose (Postgres, llama-server и др.).
- **Тесты**: pytest с SQLite in-memory для CRUD/API.

Сильные стороны — разделение UI/API/ML и наличие тестов CRUD/API. Основные слабые места — безопасность (аутентификация/секреты), устойчивость импортов (sys.path/фолбэки), местами нестабильные тесты по времени и отсутствие миграций.

## Оценки по подсистемам

- **Backend API (FastAPI)**: **6.5/10**
  - Плюсы: структурированные эндпоинты, валидация, обработка ошибок.
  - Минусы: нет полноценной auth-схемы, CORS открыт, `create_all()` в рантайме вместо миграций.

- **DB/CRUD слой**: **6/10**
  - Плюсы: понятные CRUD-методы, ограничения/индексы в моделях.
  - Минусы: производительность batch-операций (много коммитов/циклов), `datetime.now()` внутри бизнес-логики осложняет тестируемость.

- **Forecasting/ML (Prophet)**: **6/10**
  - Плюсы: тюнинг параметров, метрики качества, сохранение моделей/метаданных.
  - Минусы: мало тестов на ML-часть, есть тяжёлые операции (CV) без явных лимитов/таймаутов.

- **UI (Streamlit)**: **5.5/10**
  - Плюсы: функционально богатые страницы, кэширование `st.cache_data`, много графиков.
  - Минусы: много импорт-хаков (`sys.path`), fallback-import через `importlib`, смешение UI/ETL/логики, сложнее сопровождать.

- **Auth/Security**: **3/10**
  - Плюсы: есть заготовка Keycloak-интеграции.
  - Минусы: рискованные практики проверки токена/секретов, отсутствует единая схема авторизации в API.

- **Тесты**: **7/10**
  - Плюсы: покрытие CRUD и эндпоинтов, изолированная БД на SQLite.
  - Минусы: потенциальная «хрупкость» тестов из-за зависимостей от текущего времени.

- **DevOps/Docker**: **5.5/10**
  - Плюсы: есть compose для локального стека.
  - Минусы: много закомментированных секций, мало healthchecks, не формализованы переменные окружения/секреты.

- **Документация**: **7/10**
  - Плюсы: архитектура/тестирование/эндпоинты задокументированы.
  - Минусы: ревью и «план стабилизации» лучше держать в одном месте (этот файл закрывает пробел).

## Ключевые риски и проблемы (по приоритету)

### Высокий приоритет

1) **Безопасность токенов/секретов (Keycloak)**
- Риск: принятие невалидных токенов/утечка секретов клиента.
- Рекомендация: убрать дефолтные секреты из кода, строго проверять `aud`/`iss`, включить корректный flow (PKCE для UI, introspection при необходимости).

2) **Открытый CORS и отсутствие auth в API**
- Риск: доступ к данным/операциям из любой среды.
- Рекомендация: ограничить `allow_origins`, добавить JWT/OAuth2 или хотя бы API-key на критичные операции.

3) **DDL в рантайме**
- В `src/app/main.py` выполняется создание таблиц при старте (`create_all`).
- Риск: неконтролируемые изменения схемы и drift окружений.
- Рекомендация: Alembic миграции, `create_all` оставить только для dev/тестов.

### Средний приоритет

4) **Нестабильные тесты из-за `datetime.now()`**
- CRUD-методы и тесты используют «текущее время» без фиксации.
- Рекомендация: заморозка времени (`freezegun`) или инъекция `now_provider`.

5) **Импорт-хак в UI**
- `sys.path` и fallback импорт через `importlib` в страницах/утилитах.
- Рекомендация: привести к нормальной структуре пакетов (src-layout) и явным импортам.

6) **Логирование**
- В проекте есть файловый логгер; важно избегать дублирования хендлеров и обеспечить корректные пути.
- Рекомендация: единая конфигурация логирования (dictConfig), уровни/формат/ротация.

### Низкий приоритет

7) **Дублирование логики и смешение ответственности**
- UI-страницы содержат много «бизнес-логики» (загрузка, фильтры, трансформации).
- Рекомендация: вынести общие функции в `src/ui/utils/` и/или API-слой.

## Рекомендации по улучшению (что делать дальше)

### План фиксов (по фазам)

**Фаза 1 — Security/Exposure**
- Привести Keycloak auth к безопасной проверке (`aud` фиксированный, `iss` проверяется).
- Убрать любые секреты/дефолты из кода (только env/секреты контейнера).
- Закрыть CORS и добавить auth на API.

**Фаза 2 — Надёжность**
- Устранить зависимость тестов от реального времени (freezegun).
- Ввести миграции Alembic и убрать `create_all()` в проде.

**Фаза 3 — Maintainability**
- Убрать `sys.path`/fallback-import, оформить нормальную package-структуру.
- Свести конфигурацию БД к единому месту (один helper), описать env vars в README.

**Фаза 4 — Performance**
- Оптимизировать batch операции (bulk insert/upsert, транзакции).
- Добавить healthchecks в docker-compose.

## Конкретные места для доработки (файлы)

- **API**
  - `src/app/main.py`: CORS, создание таблиц, подключение роутеров.
  - `src/app/endpoints.py`: обработка ошибок, лимиты, вынос констант/валидации в отдельный модуль.

- **DB**
  - `src/app/connection.py`: единая конфигурация БД (в идеале объединить с helper).
  - `src/app/dbcrud.py`, `src/app/facts_crud.py`, `src/app/preds_crud.py`: batch/коммиты/now().
  - `src/app/models.py`: ограничения и индексы ок, но следить за переносимостью (Postgres-only типы).

- **UI**
  - `src/ui/pages/*.py`: уменьшить `sys.path`/fallback import, разнести логику по утилитам.
  - `src/ui/utils/data_loader.py`: минимизировать зависимости от внутренностей backend через sys.path.

- **Auth**
  - `src/ui/auth.py`: корректная проверка JWT, конфиги только из env, убрать TODO.

- **Tests**
  - `tests/*`: стабилизация времени, добавить тесты для forecasting/anomaly.

## Приложение: что уже поправлено в рамках текущих правок

В ходе текущей серии изменений в проекте уже были сделаны некоторые «мелкие» исправления и упорядочивание (например, конфигурация isort, улучшения некоторых usage-скриптов, стабилизация логгера). Этот документ фиксирует дальнейшие шаги и приоритеты.

